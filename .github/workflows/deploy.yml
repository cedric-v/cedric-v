name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_validations:
        description: 'Exécuter les validations Lighthouse et W3C'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: ELEVENTY_ENV=prod npm run build

      - name: Ensure .nojekyll exists
        run: |
          echo "Vérification/création de .nojekyll..."
          if [ ! -f _site/.nojekyll ]; then
            echo "Création de .nojekyll dans _site..."
            touch _site/.nojekyll || (echo "❌ Impossible de créer .nojekyll" && exit 1)
          else
            echo ".nojekyll existe déjà"
          fi
          if [ -f _site/.nojekyll ]; then
            echo "✓ .nojekyll existe et est accessible"
            ls -la _site/.nojekyll
          else
            echo "❌ .nojekyll n'existe toujours pas après création"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Verify build output
        run: |
          echo "=== Vérification des fichiers générés ==="
          ls -la _site/ | head -10
          test -f _site/index.html && echo "✓ index.html existe" || echo "✗ index.html manquant"
          test -f _site/404.html && echo "✓ 404.html existe" || echo "✗ 404.html manquant"
          test -f _site/.nojekyll && echo "✓ .nojekyll existe" || echo "✗ .nojekyll manquant"
          test -f _site/fr/index.html && echo "✓ fr/index.html existe" || echo "✗ fr/index.html manquant"
          echo "=== Contenu de index.html (premières lignes) ==="
          head -5 _site/index.html
          echo "=== Contenu de 404.html (premières lignes) ==="
          head -5 _site/404.html || echo "404.html non trouvé"

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './_site'

      - name: Upload build artifact for smoke test
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: './_site'
          retention-days: 1

      - name: Upload build artifact for validation
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_validations == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: validation-artifact
          path: './_site'
          retention-days: 1

  validate:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_validations == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: validation-artifact
          path: _site

      - name: Start local server
        run: |
          cd _site
          python3 -m http.server 8080 &
          echo "Server started on port 8080"
          sleep 5
        continue-on-error: true

      - name: Run Lighthouse
        run: |
          mkdir -p validation-reports
          echo "Running Lighthouse on homepage..."
          npx lighthouse http://localhost:8080/ --output=html --output-path=validation-reports/lighthouse-home.html --chrome-flags="--headless --no-sandbox" --quiet || echo "Lighthouse failed for homepage"
          npx lighthouse http://localhost:8080/ --output=json --output-path=validation-reports/lighthouse-home.json --chrome-flags="--headless --no-sandbox" --quiet || echo "Lighthouse JSON failed for homepage"
          
          echo "Running Lighthouse on French homepage..."
          npx lighthouse http://localhost:8080/fr/ --output=html --output-path=validation-reports/lighthouse-fr.html --chrome-flags="--headless --no-sandbox" --quiet || echo "Lighthouse failed for FR"
          npx lighthouse http://localhost:8080/fr/ --output=json --output-path=validation-reports/lighthouse-fr.json --chrome-flags="--headless --no-sandbox" --quiet || echo "Lighthouse JSON failed for FR"
          
          echo "Running Lighthouse on English homepage..."
          npx lighthouse http://localhost:8080/en/ --output=html --output-path=validation-reports/lighthouse-en.html --chrome-flags="--headless --no-sandbox" --quiet || echo "Lighthouse failed for EN"
          npx lighthouse http://localhost:8080/en/ --output=json --output-path=validation-reports/lighthouse-en.json --chrome-flags="--headless --no-sandbox" --quiet || echo "Lighthouse JSON failed for EN"
        continue-on-error: true

      - name: Validate HTML with W3C
        run: |
          mkdir -p validation-reports/w3c
          cd _site
          find . -name "*.html" -type f | head -10 | while read file; do
            filename=$(basename "$file" .html)
            pathname=$(echo "$file" | sed 's|^\./||' | sed 's|/|_|g')
            echo "Validating $file..."
            curl -s "https://validator.w3.org/nu/?out=json" \
              --data-binary @"$file" \
              -H "Content-Type: text/html; charset=utf-8" \
              > "../validation-reports/w3c/${pathname}.json" || true
            curl -s "https://validator.w3.org/nu/?out=html" \
              --data-binary @"$file" \
              -H "Content-Type: text/html; charset=utf-8" \
              > "../validation-reports/w3c/${pathname}.html" || true
          done
        continue-on-error: true

      - name: Create summary
        run: |
          cat > validation-reports/summary.md << 'EOF'
          # Validation Reports Summary
          
          This artifact contains validation reports generated automatically during the build process.
          
          ## Google Lighthouse Reports
          
          - `lighthouse-home.html` - Full Lighthouse report for the homepage (HTML format)
          - `lighthouse-fr.html` - Full Lighthouse report for the French homepage (HTML format)
          - `lighthouse-en.html` - Full Lighthouse report for the English homepage (HTML format, if available)
          - `lighthouse-home.json` - Lighthouse data for the homepage (JSON format)
          - `lighthouse-fr.json` - Lighthouse data for the French homepage (JSON format)
          
          ## W3C HTML Validation Reports
          
          - `w3c/` directory containing validation reports for up to 10 HTML pages
            - Each page has both HTML and JSON format reports
            - Files are named based on the page path (e.g., `index.html`, `fr_index.html`, `a-propos_philosophie_index.html`)
          
          ## How to Use
          
          **Lighthouse reports:**
          - Open the HTML files in your browser for a visual, interactive report
          - Lighthouse evaluates Performance, Accessibility, Best Practices, and SEO
          - Aim for scores above 90 in each category
          
          **W3C Validation reports:**
          - Open the HTML reports to see detailed validation errors and warnings
          - Fix any errors (marked in red) and review warnings (marked in yellow)
          - Valid HTML ensures better browser compatibility and accessibility
          EOF

      - name: Upload validation reports
        uses: actions/upload-artifact@v4
        with:
          name: validation-reports
          path: validation-reports/
          retention-days: 30

  smoke-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: _site

      - name: Ensure .nojekyll exists (smoke test)
        run: |
          if [ ! -f _site/.nojekyll ]; then
            echo "Création de .nojekyll dans _site pour le smoke test..."
            touch _site/.nojekyll || (echo "❌ Impossible de créer .nojekyll" && exit 1)
          fi

      - name: Verify critical files exist
        run: |
          echo "=== Vérification des fichiers critiques ==="
          test -f _site/index.html || (echo "❌ index.html manquant" && exit 1)
          test -f _site/404.html || (echo "❌ 404.html manquant" && exit 1)
          test -f _site/fr/index.html || (echo "❌ fr/index.html manquant" && exit 1)
          test -f _site/.nojekyll || (echo "❌ .nojekyll manquant" && exit 1)
          echo "✓ Tous les fichiers critiques existent"

      - name: Start local server
        run: |
          cd _site
          python3 -m http.server 8080 > /dev/null 2>&1 &
          echo $! > /tmp/server.pid
          echo "Serveur démarré sur le port 8080"
          sleep 3

      - name: Test page accessibility
        run: |
          echo "=== Tests d'accessibilité des pages ==="
          
          # Fonction pour tester une page
          test_page() {
            local url=$1
            local expected_status=$2
            local description=$3
            
            echo "Test: $description ($url)"
            response=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:8080$url" || echo "000")
            
            if [ "$response" = "$expected_status" ]; then
              echo "  ✓ Status $response (attendu: $expected_status)"
            else
              echo "  ❌ Status $response (attendu: $expected_status)"
              exit 1
            fi
          }
          
          # Test de la page d'accueil
          test_page "/" "200" "Page d'accueil (index.html)"
          
          # Test de la page 404
          test_page "/404.html" "200" "Page 404 personnalisée"
          
          # Test de la page française
          test_page "/fr/" "200" "Page d'accueil française"
          
          # Test de la page anglaise
          test_page "/en/" "200" "Page d'accueil anglaise"
          
          # Test d'une page inexistante (devrait retourner 404)
          test_page "/page-inexistante-12345" "404" "Page inexistante"
          
          echo "✓ Tous les tests d'accessibilité ont réussi"

      - name: Verify HTML content
        run: |
          echo "=== Vérification du contenu HTML ==="
          
          # Vérifier que index.html contient du contenu valide
          if grep -q "<!DOCTYPE html\|<html" _site/index.html; then
            echo "✓ index.html contient du HTML valide"
          else
            echo "❌ index.html ne contient pas de HTML valide"
            exit 1
          fi
          
          # Vérifier que 404.html contient "404" ou "Page non trouvée"
          if grep -qi "404\|Page non trouvée\|not found" _site/404.html; then
            echo "✓ 404.html contient le contenu attendu"
          else
            echo "❌ 404.html ne contient pas le contenu attendu"
            exit 1
          fi
          
          # Vérifier que fr/index.html contient du contenu valide
          if grep -q "<!DOCTYPE html\|<html" _site/fr/index.html; then
            echo "✓ fr/index.html contient du HTML valide"
          else
            echo "❌ fr/index.html ne contient pas de HTML valide"
            exit 1
          fi
          
          echo "✓ Toutes les vérifications de contenu ont réussi"

      - name: Stop local server
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) 2>/dev/null || true
            rm /tmp/server.pid
          fi

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: [build, smoke-test]
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

